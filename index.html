<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ward Manager (UK) — Prototype</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; }
    header { padding: 14px 16px; border-bottom: 1px solid rgba(127,127,127,.35); display: flex; gap: 12px; align-items: baseline; }
    header h1 { font-size: 16px; margin: 0; }
    header .sub { opacity: .75; font-size: 12px; }
    main { display: grid; grid-template-columns: 360px 1fr; gap: 0; min-height: calc(100vh - 54px); }
    aside { border-right: 1px solid rgba(127,127,127,.35); padding: 14px 16px; overflow: auto; }
    section { padding: 14px 16px; overflow: auto; }
    .card { border: 1px solid rgba(127,127,127,.35); border-radius: 10px; padding: 12px; margin-bottom: 12px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .row > * { flex: 1 1 auto; }
    .kpi { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 10px; }
    .kpi .box { border: 1px solid rgba(127,127,127,.35); border-radius: 10px; padding: 10px; }
    .box .lbl { font-size: 11px; opacity: .7; }
    .box .val { font-size: 18px; font-weight: 700; }
    .small { font-size: 12px; opacity: .85; }
    .muted { opacity: .7; }
    .danger { color: #b00020; }
    .good { color: #0a7; }
    button { cursor: pointer; border-radius: 10px; border: 1px solid rgba(127,127,127,.35); padding: 10px 12px; background: transparent; }
    button:hover { filter: brightness(1.05); }
    button:disabled { opacity: .45; cursor: not-allowed; }
    select, input { border-radius: 10px; border: 1px solid rgba(127,127,127,.35); padding: 8px 10px; background: transparent; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px 6px; border-bottom: 1px solid rgba(127,127,127,.25); font-size: 13px; text-align: left; }
    th { font-size: 12px; opacity: .8; }
    .tag { display: inline-block; border: 1px solid rgba(127,127,127,.35); border-radius: 999px; padding: 2px 8px; font-size: 11px; opacity: .85; }
    .log { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; white-space: pre-wrap; }
    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .grid3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    .hr { height: 1px; background: rgba(127,127,127,.35); margin: 12px 0; }
    .pillrow { display:flex; gap:8px; flex-wrap: wrap; }
    .right { text-align: right; }
    @media (max-width: 980px) { main { grid-template-columns: 1fr; } aside { border-right: none; border-bottom: 1px solid rgba(127,127,127,.35);} }
  </style>
</head>
<body>
<header>
  <h1>Ward Manager (UK) — Stats Prototype</h1>
  <div class="sub">Single-ward local election • weekly turns • noisy polling • micro-targeting • leaflets • canvassing • GOTV</div>
</header>

<main>
  <aside>
    <div class="card">
      <div class="row">
        <div>
          <div class="small muted">Ward</div>
          <div style="font-weight:700" id="wardName">—</div>
          <div class="small muted" id="wardMeta">—</div>
        </div>
        <div class="right">
          <div class="small muted">Week</div>
          <div style="font-weight:700; font-size:18px" id="weekLabel">—</div>
          <div class="small muted" id="phaseLabel">—</div>
        </div>
      </div>
      <div class="hr"></div>
      <div class="kpi">
        <div class="box">
          <div class="lbl">Money (£)</div>
          <div class="val" id="kpiMoney">—</div>
          <div class="small muted">Spend limits not enforced in this prototype</div>
        </div>
        <div class="box">
          <div class="lbl">Vol. Hours</div>
          <div class="val" id="kpiVol">—</div>
          <div class="small muted">Used for doors & delivery</div>
        </div>
        <div class="box">
          <div class="lbl">Candidate Energy</div>
          <div class="val" id="kpiEnergy">—</div>
          <div class="small muted">Drops with events/press</div>
        </div>
        <div class="box">
          <div class="lbl">Ethical Debt</div>
          <div class="val" id="kpiEthics">—</div>
          <div class="small muted">Increases exposure risk</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div>
          <div class="small muted">Issue Salience (Top 3)</div>
          <div class="pillrow" id="topIssues">—</div>
        </div>
      </div>
      <div class="hr"></div>
      <div class="small muted">Your baseline strengths</div>
      <div class="grid2" id="candidateStats"></div>
    </div>

    <div class="card">
      <div class="row">
        <button id="btnPoll">Run Internal Poll (£250)</button>
        <button id="btnNext">Advance Week ▶</button>
      </div>
      <div class="small muted" style="margin-top:8px">
        Tip: pick a district + issue combo and repeat for a few weeks to see momentum and saturation effects.
      </div>
    </div>

    <div class="card">
      <div class="small muted">Event Feed</div>
      <div class="log" id="eventLog">—</div>
    </div>
  </aside>

  <section>
    <div class="card">
      <div class="row">
        <div>
          <div class="small muted">Action Planner (This Week)</div>
          <div style="font-weight:700">Choose one primary action</div>
        </div>
        <div class="right">
          <span class="tag" id="actionBudgetTag">Budget: —</span>
        </div>
      </div>

      <div class="hr"></div>

      <div class="grid3">
        <div>
          <div class="small muted">Action</div>
          <select id="selAction">
            <option value="canvass">Door-knocking canvass</option>
            <option value="leaflet">Leaflet drop</option>
            <option value="social">Social media ads</option>
            <option value="press">Local press / interview</option>
            <option value="gotv">GOTV prep (late campaign)</option>
          </select>
          <div class="small muted" style="margin-top:8px">District</div>
          <select id="selDistrict"></select>
        </div>

        <div>
          <div class="small muted">Issue</div>
          <select id="selIssue"></select>
          <div class="small muted" style="margin-top:8px">Frame</div>
          <select id="selFrame">
            <option value="fairness">Fairness</option>
            <option value="safety">Safety</option>
            <option value="money">Cost of living / Council tax</option>
            <option value="community">Community / pride</option>
            <option value="competence">Competence</option>
          </select>
        </div>

        <div>
          <div class="small muted">Tone</div>
          <select id="selTone">
            <option value="positive">Positive</option>
            <option value="empathetic">Empathetic</option>
            <option value="contrast">Contrast</option>
            <option value="attack">Attack (risky)</option>
          </select>
          <div class="small muted" style="margin-top:8px">Intensity</div>
          <input id="rngIntensity" type="range" min="1" max="5" value="3" />
          <div class="small muted">1 = light, 5 = heavy saturation</div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <button id="btnDoAction">Execute Action</button>
        <button id="btnResetWeek">Reset Week (no cost)</button>
        <div class="right small muted" id="weekNotes">—</div>
      </div>
    </div>

    <div class="grid2">
      <div class="card">
        <div class="row">
          <div>
            <div class="small muted">Polling (Latest)</div>
            <div style="font-weight:700">Likely Voters — noisy</div>
          </div>
          <div class="right small muted" id="pollMeta">—</div>
        </div>
        <div class="hr"></div>
        <table>
          <thead>
          <tr><th>Candidate</th><th class="right">%</th><th>Notes</th></tr>
          </thead>
          <tbody id="pollTable"></tbody>
        </table>
        <div class="small muted" id="pollCaveat"></div>
      </div>

      <div class="card">
        <div class="small muted">District Dashboard</div>
        <div style="font-weight:700" id="districtTitle">—</div>
        <div class="hr"></div>
        <table>
          <tbody id="districtStats"></tbody>
        </table>
        <div class="hr"></div>
        <div class="small muted">Micro history (your activity & saturation)</div>
        <div class="log" id="districtHistory">—</div>
      </div>
    </div>

    <div class="card">
      <div class="small muted">All Districts Snapshot</div>
      <div class="hr"></div>
      <table>
        <thead>
        <tr>
          <th>District</th>
          <th class="right">Voters</th>
          <th class="right">Turnout</th>
          <th class="right">You</th>
          <th class="right">Con</th>
          <th class="right">Lab</th>
          <th class="right">Ind</th>
          <th>Top Issue</th>
        </tr>
        </thead>
        <tbody id="allDistricts"></tbody>
      </table>
    </div>
  </section>
</main>

<script>
/**
 * WARD MANAGER (UK) — Minimal-but-deep prototype in one HTML file.
 * - One ward with 12 districts
 * - Voters represented as district aggregates + segments
 * - Weekly actions: canvass / leaflet / social / press / GOTV
 * - Messaging variables: issue + frame + tone + intensity
 * - Effects: persuasion + turnout + trust + fatigue/saturation + backlash risk
 * - Polling: noisy likely-voter estimate
 *
 * This is a prototype foundation; you can expand data, UI, and AI opponents.
 */

/* ---------- Utilities ---------- */
const clamp = (x, a, b) => Math.max(a, Math.min(b, x));
const rnd = (a=0, b=1) => a + Math.random() * (b-a);
const irnd = (a, b) => Math.floor(rnd(a, b+1));
const pick = (arr) => arr[Math.floor(Math.random()*arr.length)];
function fmt(n){ return n.toLocaleString('en-GB'); }
function pct(n){ return `${(n*100).toFixed(1)}%`; }

/* ---------- Game Data ---------- */
const GAME = {
  ward: {
    name: "Greybridge North",
    council: "Unitary Authority (England)",
    electorate: 9180,
    population: 12400,
    baselineTurnout: 0.48,
  },
  week: 1,
  totalWeeks: 24, // shorter campaign for prototype; extend to 52 easily
  phase: "Campaign",
  resources: {
    money: 6200,
    volHours: 110,
    energy: 85,
    ethicalDebt: 0,
  },
  candidate: {
    name: "Elliot Price (You)",
    party: "Greenbridge Residents",
    stats: { charisma: 13, discipline: 12, authenticity: 15, policy: 11, debate: 10, localCred: 14, stamina: 12, gaffeRes: 11 },
    narrative: { awareness: 0.28, trust: 0.52 } // ward-level baseline
  },
  opponents: [
    { name: "Margaret Holloway", party: "Conservative", style: "Incumbent Defender", base: { awareness: 0.68, trust: 0.54 } },
    { name: "Liam Carter", party: "Labour", style: "Ground-Game Maximalist", base: { awareness: 0.46, trust: 0.49 } },
    { name: "Nadia Rahman", party: "Independent", style: "Local Issue Champion", base: { awareness: 0.33, trust: 0.50 } },
  ],
  issues: [
    { key:"asb", name:"Anti-social behaviour", salience: 78, polarity: 0.20 },
    { key:"parking", name:"Parking & permits", salience: 72, polarity: 0.35 },
    { key:"cTax", name:"Council tax & value", salience: 64, polarity: 0.25 },
    { key:"bins", name:"Bin collections", salience: 56, polarity: 0.10 },
    { key:"planning", name:"Housing & development", salience: 60, polarity: 0.45 },
    { key:"roads", name:"Potholes & roads", salience: 52, polarity: 0.15 },
    { key:"youth", name:"Youth services", salience: 44, polarity: 0.30 },
  ],
  // Districts store "true" latent support & turnout (hidden), plus saturation and contact history
  districts: []
};

/* ---------- District Generation ---------- */
function makeDistricts(){
  const templates = [
    { name:"Riverside Estate", voters:1050, baseTurnout:0.36, skew:"working", top:"asb" },
    { name:"Old Greybridge", voters:740, baseTurnout:0.62, skew:"older", top:"cTax" },
    { name:"Kingsway Newbuilds", voters:1300, baseTurnout:0.44, skew:"young", top:"parking" },
    { name:"St. Mark’s Village", voters:620, baseTurnout:0.64, skew:"conservative", top:"planning" },
    { name:"Industrial Crescent", voters:890, baseTurnout:0.40, skew:"union", top:"roads" },
    { name:"Greybridge High Street", voters:520, baseTurnout:0.50, skew:"mixed", top:"bins" },
    { name:"Willow Park", voters:800, baseTurnout:0.52, skew:"family", top:"asb" },
    { name:"The Gables", voters:610, baseTurnout:0.60, skew:"affluent", top:"cTax" },
    { name:"Elm Terrace", voters:760, baseTurnout:0.48, skew:"renters", top:"parking" },
    { name:"Harbour View", voters:430, baseTurnout:0.58, skew:"older", top:"roads" },
    { name:"Northgate Flats", voters:860, baseTurnout:0.33, skew:"renters", top:"asb" },
    { name:"Meadowfield", voters:600, baseTurnout:0.55, skew:"family", top:"planning" },
  ];

  // Baseline "true" vote shares per district (latent). Must sum ~1
  // We'll generate around a ward-wide baseline with district-specific noise.
  const wardBase = { you: 0.27, con: 0.33, lab: 0.30, ind: 0.10 };

  GAME.districts = templates.map(t => {
    // district lean by "skew"
    const delta = { you:0, con:0, lab:0, ind:0 };
    switch(t.skew){
      case "older": delta.con += 0.03; delta.you -= 0.01; delta.lab -= 0.01; break;
      case "affluent": delta.con += 0.05; delta.you -= 0.01; delta.lab -= 0.03; break;
      case "working": delta.lab += 0.04; delta.con -= 0.02; delta.you -= 0.01; break;
      case "union": delta.lab += 0.05; delta.con -= 0.03; break;
      case "young": delta.you += 0.03; delta.con -= 0.02; delta.ind += 0.01; break;
      case "renters": delta.you += 0.02; delta.lab += 0.02; delta.con -= 0.03; break;
      case "conservative": delta.con += 0.06; delta.lab -= 0.03; delta.you -= 0.02; break;
      case "family": delta.you += 0.02; delta.con += 0.01; delta.lab -= 0.02; break;
      default: break;
    }

    // Apply noise
    const noise = () => rnd(-0.015, 0.015);

    let you = wardBase.you + delta.you + noise();
    let con = wardBase.con + delta.con + noise();
    let lab = wardBase.lab + delta.lab + noise();
    let ind = wardBase.ind + delta.ind + noise();

    // Normalise to sum 1, ensure bounds
    const raw = [you, con, lab, ind].map(v => clamp(v, 0.03, 0.85));
    const sum = raw.reduce((a,b)=>a+b,0);
    [you, con, lab, ind] = raw.map(v => v/sum);

    return {
      name: t.name,
      voters: t.voters,
      skew: t.skew,
      topIssueKey: t.top,
      latent: {
        support: { you, con, lab, ind }, // hidden true
        turnout: clamp(t.baseTurnout + rnd(-0.03,0.03), 0.22, 0.75), // hidden true
        awarenessYou: clamp(GAME.candidate.narrative.awareness + rnd(-0.06,0.06), 0.10, 0.80),
        trustYou: clamp(GAME.candidate.narrative.trust + rnd(-0.08,0.08), 0.25, 0.80),
      },
      saturation: {
        // tracks fatigue per channel per issue
        canvass: {}, leaflet: {}, social: {}, press: {}, gotv: {}
      },
      contact: {
        doors: 0, leaflets: 0, socialImpressions: 0, pressHits: 0, gotvTouches: 0
      },
      history: []
    };
  });
}

/* ---------- Mechanics ---------- */

function issueByKey(key){ return GAME.issues.find(i=>i.key===key); }

function top3Issues(){
  return [...GAME.issues].sort((a,b)=>b.salience-a.salience).slice(0,3);
}

// Impact factors by frame vs issue (soft mapping)
const FRAME_FIT = {
  fairness: { cTax: 0.9, parking: 0.75, asb: 0.6, bins: 0.7, planning: 0.65, roads: 0.7, youth: 0.85 },
  safety: { asb: 0.95, parking: 0.55, cTax: 0.45, bins: 0.55, planning: 0.5, roads: 0.6, youth: 0.5 },
  money: { cTax: 0.95, parking: 0.7, asb: 0.55, bins: 0.65, planning: 0.6, roads: 0.7, youth: 0.55 },
  community: { bins: 0.75, roads: 0.7, youth: 0.8, asb: 0.75, planning: 0.65, parking: 0.6, cTax: 0.55 },
  competence: { bins: 0.8, roads: 0.85, parking: 0.7, cTax: 0.75, asb: 0.7, planning: 0.75, youth: 0.65 },
};

const TONE_RISK = { positive: 0.02, empathetic: 0.03, contrast: 0.05, attack: 0.11 };
const TONE_TRUST = { positive: 0.015, empathetic: 0.020, contrast: 0.005, attack: -0.018 };

function getSat(d, channel, issueKey){
  return d.saturation[channel][issueKey] ?? 0;
}
function addSat(d, channel, issueKey, amount){
  d.saturation[channel][issueKey] = clamp(getSat(d, channel, issueKey) + amount, 0, 1.6);
}
function decaySaturation(){
  // weekly decay
  for(const d of GAME.districts){
    for(const ch of ["canvass","leaflet","social","press","gotv"]){
      for(const key of Object.keys(d.saturation[ch])){
        d.saturation[ch][key] = clamp(d.saturation[ch][key] * 0.78, 0, 2);
      }
    }
  }
}

function likelyVoterWeight(turnout){
  // Convert turnout probability to a weight for likely-voter model.
  // Higher turnout districts matter more in LV.
  return 0.5 + turnout; // 0.7..1.25-ish
}

function computeWardTotals(){
  // Combine districts into ward-wide latent (ground truth).
  let totalW = 0;
  const totals = { you:0, con:0, lab:0, ind:0 };
  let turnout = 0;

  for(const d of GAME.districts){
    const w = d.voters;
    totalW += w;
    for(const k of Object.keys(totals)) totals[k] += d.latent.support[k] * w;
    turnout += d.latent.turnout * w;
  }
  for(const k of Object.keys(totals)) totals[k] /= totalW;
  turnout /= totalW;
  return { support: totals, turnout };
}

function computeLikelyVoterTotals(){
  let totalW = 0;
  const totals = { you:0, con:0, lab:0, ind:0 };
  let turnout = 0;

  for(const d of GAME.districts){
    const w = d.voters * likelyVoterWeight(d.latent.turnout);
    totalW += w;
    for(const k of Object.keys(totals)) totals[k] += d.latent.support[k] * w;
    turnout += d.latent.turnout * w;
  }
  for(const k of Object.keys(totals)) totals[k] /= totalW;
  turnout /= totalW;
  return { support: totals, turnout };
}

function noisyPollFromTruth(truth){
  // Add sampling error + house effects.
  const n = irnd(420, 820);
  const moE = 1.96 * Math.sqrt(0.25 / n); // rough max MoE for proportions
  const house = { you: rnd(-0.01,0.01), con: rnd(-0.012,0.012), lab: rnd(-0.012,0.012), ind: rnd(-0.008,0.008) };

  let vals = { ...truth.support };
  // Apply noise per candidate; keep sum 1 via renormalisation
  for(const k of Object.keys(vals)){
    vals[k] += rnd(-moE, moE) + house[k];
    vals[k] = clamp(vals[k], 0.01, 0.85);
  }
  const sum = Object.values(vals).reduce((a,b)=>a+b,0);
  for(const k of Object.keys(vals)) vals[k] /= sum;

  // Turnout estimate with noise
  let t = truth.turnout + rnd(-0.03,0.03);
  t = clamp(t, 0.25, 0.70);

  return { n, moE, support: vals, turnout: t };
}

function applyAction({ action, districtName, issueKey, frame, tone, intensity }){
  const d = GAME.districts.find(x=>x.name===districtName);
  const issue = issueByKey(issueKey);
  const stats = GAME.candidate.stats;

  // Costs & resource requirements
  const costs = {
    canvass: { money: 20, vol: 18*intensity, energy: 6+intensity },
    leaflet: { money: 120*intensity, vol: 10*intensity, energy: 2+Math.floor(intensity/2) },
    social: { money: 90*intensity, vol: 2, energy: 2 },
    press: { money: 0, vol: 0, energy: 10+intensity },
    gotv: { money: 40, vol: 16*intensity, energy: 7+intensity },
  }[action];

  // Late-game gating for GOTV
  if(action === "gotv" && GAME.week < Math.floor(GAME.totalWeeks*0.75)){
    return { ok:false, msg:"GOTV prep unlocks in the late campaign (final quarter)." };
  }

  // Check resources
  if(GAME.resources.money < costs.money) return { ok:false, msg:"Not enough money." };
  if(GAME.resources.volHours < costs.vol) return { ok:false, msg:"Not enough volunteer hours." };
  if(GAME.resources.energy < costs.energy) return { ok:false, msg:"Candidate too exhausted." };

  // Spend resources
  GAME.resources.money -= costs.money;
  GAME.resources.volHours -= costs.vol;
  GAME.resources.energy -= costs.energy;

  // Compute effectiveness
  const sal = issue.salience / 100;
  const fit = (FRAME_FIT[frame]?.[issueKey] ?? 0.6);
  const toneTrust = TONE_TRUST[tone] ?? 0;
  const toneRisk = TONE_RISK[tone] ?? 0.04;

  // Candidate quality multipliers
  const deliveryQ =
    (0.45 +
      0.02*stats.charisma +
      0.015*stats.authenticity +
      0.01*stats.policy) / 1.0;

  // Channel strengths
  const channelBase = {
    canvass: 0.55,
    leaflet: 0.40,
    social: 0.36,
    press: 0.30,
    gotv: 0.50
  }[action];

  // Saturation dampening
  const sat = getSat(d, action, issueKey);
  const satDamp = 1 / (1 + 1.2*sat); // diminishing returns

  // Localisation bonus if using district's top issue
  const localBonus = (d.topIssueKey === issueKey) ? 1.18 : 1.0;

  // Intensity scales both impact and backlash
  const intensityScale = 0.55 + 0.18*intensity; // 0.73..1.45

  // Base persuasion effect magnitude
  let impact = channelBase * sal * fit * deliveryQ * satDamp * localBonus * intensityScale;

  // Convert to vote share movement (small, realistic weekly nudges)
  // We shift from opponents to you, and potentially shift turnout
  const maxShift = 0.010 * impact; // up to ~1 point in very good conditions
  const shift = clamp(rnd(0.35,1.0)*maxShift, 0, 0.012);

  // Turnout movement for GOTV and some empathetic canvass
  let turnoutBoost = 0;
  if(action === "gotv") turnoutBoost = clamp(0.004*impact*intensity, 0, 0.02);
  if(action === "canvass" && tone === "empathetic") turnoutBoost = clamp(0.0025*impact*intensity, 0, 0.012);

  // Trust/awareness changes (small)
  const trustDelta = toneTrust * (0.6 + 0.1*intensity) * satDamp * localBonus;
  const awarenessDelta = clamp(0.01 * channelBase * (0.8 + 0.08*intensity) * satDamp, 0, 0.02);

  // Backlash / scandal risk
  const backlashP = clamp((toneRisk + 0.03*(intensity-1)) * (0.6 + 0.6*sat), 0, 0.35);
  const backlashRoll = Math.random() < backlashP;

  // Ethical debt: attack / dark-ish behaviour
  if(action === "social" && tone !== "positive") GAME.resources.ethicalDebt += 0.6 * intensity;
  if(tone === "attack") GAME.resources.ethicalDebt += 0.9 * intensity;

  // Apply persuasion: move vote share from strongest opponent in this district
  // (you steal mostly from nearest competitor; some from incumbent)
  const s = d.latent.support;
  const oppOrder = [
    { k:"con", v:s.con },
    { k:"lab", v:s.lab },
    { k:"ind", v:s.ind },
  ].sort((a,b)=>b.v-a.v);
  const takeFrom = oppOrder[0].k;

  const actualShift = backlashRoll ? shift * 0.25 : shift; // backlash mutes persuasion
  s.you = clamp(s.you + actualShift, 0.01, 0.95);
  s[takeFrom] = clamp(s[takeFrom] - actualShift*0.85, 0.01, 0.95);
  // distribute remainder across others a bit
  const rem = actualShift*0.15;
  const other = ["con","lab","ind"].filter(k=>k!==takeFrom);
  s[other[0]] = clamp(s[other[0]] - rem*0.6, 0.01, 0.95);
  s[other[1]] = clamp(s[other[1]] - rem*0.4, 0.01, 0.95);

  // Renormalise
  const sum = s.you + s.con + s.lab + s.ind;
  s.you/=sum; s.con/=sum; s.lab/=sum; s.ind/=sum;

  // Apply turnout
  d.latent.turnout = clamp(d.latent.turnout + turnoutBoost, 0.20, 0.78);

  // Apply awareness & trust (district-level)
  d.latent.awarenessYou = clamp(d.latent.awarenessYou + awarenessDelta, 0.05, 0.95);
  d.latent.trustYou = clamp(d.latent.trustYou + trustDelta, 0.15, 0.90);

  // Add saturation
  addSat(d, action, issueKey, 0.22*intensity);

  // Update contact counters (for display)
  if(action==="canvass") d.contact.doors += Math.floor(50*intensity*satDamp);
  if(action==="leaflet") d.contact.leaflets += Math.floor(220*intensity*satDamp);
  if(action==="social") d.contact.socialImpressions += Math.floor(600*intensity*satDamp);
  if(action==="press") d.contact.pressHits += 1;
  if(action==="gotv") d.contact.gotvTouches += Math.floor(80*intensity*satDamp);

  const summary = {
    ok:true,
    shift: actualShift,
    turnoutBoost,
    trustDelta,
    awarenessDelta,
    backlash: backlashRoll,
    backlashP,
    impact,
    satBefore: sat
  };

  d.history.push({
    week: GAME.week,
    action, issueKey, frame, tone, intensity,
    shift: actualShift,
    turnoutBoost,
    backlash: backlashRoll
  });

  return summary;
}

function opponentPhase(){
  // Lightweight opponent actions: each week they nudge a couple districts.
  // This is deliberately simple; you can replace with full AI playbooks later.
  for(const opp of GAME.opponents){
    const focus = pick(GAME.districts);
    const issueKey = focus.topIssueKey;
    // Opponent effect reduces your share slightly in that district (competition).
    const s = focus.latent.support;

    // Incumbent tends to benefit from name recognition late
    let base = 0.0012;
    if(opp.party==="Conservative") base += 0.0005;
    if(opp.style.includes("Ground")) base += 0.0007;

    // Random
    const delta = clamp(base + rnd(-0.0005,0.0012), 0, 0.003);
    // Pull from you toward opponent party bucket
    const k = (opp.party==="Conservative") ? "con" :
              (opp.party==="Labour") ? "lab" : "ind";

    s.you = clamp(s.you - delta, 0.01, 0.95);
    s[k] = clamp(s[k] + delta*0.9, 0.01, 0.95);
    // renormalise
    const sum = s.you + s.con + s.lab + s.ind;
    s.you/=sum; s.con/=sum; s.lab/=sum; s.ind/=sum;

    // small narrative effect: if opponent is active and you are saturated poorly, trust may drift
    if(Math.random() < 0.15) focus.latent.trustYou = clamp(focus.latent.trustYou - 0.002, 0.15, 0.9);
  }
}

function eventsPhase(){
  const log = [];

  // Salience drift: local issues ebb/flow
  for(const issue of GAME.issues){
    issue.salience = clamp(issue.salience + rnd(-3,3), 25, 90);
  }

  // Occasional events
  const pEvent = 0.28;
  if(Math.random() < pEvent){
    const type = pick(["asbSpike","binMiss","planningRow","nationalWave","candidateGaffe","goodEndorsement","weatherSnap"]);
    if(type==="asbSpike"){
      issueByKey("asb").salience = clamp(issueByKey("asb").salience + irnd(6,14), 25, 95);
      log.push("Event: anti-social behaviour incident spikes concern (+ASB salience).");
    }
    if(type==="binMiss"){
      issueByKey("bins").salience = clamp(issueByKey("bins").salience + irnd(6,12), 25, 95);
      log.push("Event: missed bin collections trend on local Facebook (+Bins salience).");
    }
    if(type==="planningRow"){
      issueByKey("planning").salience = clamp(issueByKey("planning").salience + irnd(7,15), 25, 95);
      log.push("Event: planning application row heats up (+Development salience, polarising).");
    }
    if(type==="nationalWave"){
      // National politics bleed-through, random direction, small
      const swingToCon = Math.random() < 0.5;
      for(const d of GAME.districts){
        const s = d.latent.support;
        const delta = rnd(0.0005,0.002);
        if(swingToCon){ s.con += delta; s.you -= delta*0.45; s.lab -= delta*0.45; }
        else { s.lab += delta; s.you -= delta*0.35; s.con -= delta*0.55; }
        const sum = s.you + s.con + s.lab + s.ind;
        s.you/=sum; s.con/=sum; s.lab/=sum; s.ind/=sum;
      }
      log.push(`Event: national politics breaks through (small ward-wide drift ${swingToCon ? "toward Con" : "toward Lab"}).`);
    }
    if(type==="candidateGaffe"){
      const hit = rnd(0.006, 0.018) * (1 + GAME.resources.ethicalDebt*0.03);
      GAME.resources.energy = clamp(GAME.resources.energy - irnd(6,12), 0, 100);
      for(const d of GAME.districts){
        d.latent.trustYou = clamp(d.latent.trustYou - hit*0.25, 0.15, 0.9);
        // small vote share hit
        const s = d.latent.support;
        s.you = clamp(s.you - hit*0.22, 0.01, 0.95);
        s.con = clamp(s.con + hit*0.08, 0.01, 0.95);
        s.lab = clamp(s.lab + hit*0.10, 0.01, 0.95);
        s.ind = clamp(s.ind + hit*0.04, 0.01, 0.95);
        const sum = s.you + s.con + s.lab + s.ind;
        s.you/=sum; s.con/=sum; s.lab/=sum; s.ind/=sum;
      }
      log.push("Event: minor gaffe picked up locally (trust & support down a touch).");
    }
    if(type==="goodEndorsement"){
      const bump = rnd(0.003, 0.010);
      GAME.resources.energy = clamp(GAME.resources.energy + irnd(2,6), 0, 100);
      for(const d of GAME.districts){
        d.latent.awarenessYou = clamp(d.latent.awarenessYou + bump*0.6, 0.05, 0.95);
        d.latent.trustYou = clamp(d.latent.trustYou + bump*0.5, 0.15, 0.9);
      }
      log.push("Event: respected community endorsement (small awareness/trust bump).");
    }
    if(type==="weatherSnap"){
      // affects turnout elasticity
      const cold = Math.random() < 0.5;
      for(const d of GAME.districts){
        d.latent.turnout = clamp(d.latent.turnout + (cold ? rnd(-0.006,-0.001) : rnd(0.001,0.005)), 0.2, 0.78);
      }
      log.push(`Event: weather snap (${cold ? "cold/rain" : "mild"}) nudges turnout.`);
    }
  }

  // Ethical debt slowly fades
  GAME.resources.ethicalDebt = clamp(GAME.resources.ethicalDebt * 0.92, 0, 999);

  return log;
}

function refreshWeeklyResources(){
  // fundraising + volunteer recruitment baseline
  const fund = irnd(140, 420);
  const vols = irnd(12, 30);
  const energyRegen = irnd(8, 16);

  GAME.resources.money += fund;
  GAME.resources.volHours += vols;
  GAME.resources.energy = clamp(GAME.resources.energy + energyRegen, 0, 100);

  return { fund, vols, energyRegen };
}

/* ---------- UI Rendering ---------- */
const el = (id)=>document.getElementById(id);

let WEEK_ACTION_SNAPSHOT = null; // for reset week button

function snapshotWeek(){
  WEEK_ACTION_SNAPSHOT = JSON.parse(JSON.stringify({
    resources: GAME.resources,
    districts: GAME.districts,
    issues: GAME.issues,
  }));
}
function restoreWeek(){
  if(!WEEK_ACTION_SNAPSHOT) return;
  GAME.resources = JSON.parse(JSON.stringify(WEEK_ACTION_SNAPSHOT.resources));
  GAME.districts = JSON.parse(JSON.stringify(WEEK_ACTION_SNAPSHOT.districts));
  GAME.issues = JSON.parse(JSON.stringify(WEEK_ACTION_SNAPSHOT.issues));
}

function renderHeader(){
  el("wardName").textContent = `${GAME.ward.name}`;
  el("wardMeta").textContent = `${GAME.ward.council} • Electorate ${fmt(GAME.ward.electorate)} • Pop ${fmt(GAME.ward.population)}`;
  el("weekLabel").textContent = `Week ${GAME.week} / ${GAME.totalWeeks}`;
  const late = GAME.week >= Math.floor(GAME.totalWeeks*0.75);
  GAME.phase = late ? "Late Campaign" : "Campaign";
  el("phaseLabel").textContent = GAME.phase;
}

function renderKPIs(){
  el("kpiMoney").textContent = `£${fmt(Math.max(0, Math.round(GAME.resources.money)))}`;
  el("kpiVol").textContent = fmt(Math.max(0, Math.round(GAME.resources.volHours)));
  el("kpiEnergy").textContent = fmt(Math.max(0, Math.round(GAME.resources.energy)));
  el("kpiEthics").textContent = fmt(Math.round(GAME.resources.ethicalDebt));
}

function renderIssues(){
  const cont = el("topIssues");
  cont.innerHTML = "";
  for(const i of top3Issues()){
    const span = document.createElement("span");
    span.className = "tag";
    span.textContent = `${i.name} (${i.salience})`;
    cont.appendChild(span);
  }
  // issue selector
  const sel = el("selIssue");
  sel.innerHTML = "";
  for(const i of [...GAME.issues].sort((a,b)=>b.salience-a.salience)){
    const opt = document.createElement("option");
    opt.value = i.key;
    opt.textContent = `${i.name} (salience ${i.salience})`;
    sel.appendChild(opt);
  }
}

function renderCandidateStats(){
  const stats = GAME.candidate.stats;
  const rows = [
    ["Charisma", stats.charisma], ["Discipline", stats.discipline],
    ["Authenticity", stats.authenticity], ["Policy", stats.policy],
    ["Debate", stats.debate], ["Local Cred", stats.localCred],
    ["Stamina", stats.stamina], ["Gaffe Res", stats.gaffeRes],
  ];
  const wrap = el("candidateStats");
  wrap.innerHTML = "";
  for(const [k,v] of rows){
    const box = document.createElement("div");
    box.className = "box";
    box.innerHTML = `<div class="lbl">${k}</div><div class="val">${v}</div>`;
    wrap.appendChild(box);
  }
}

function renderSelectors(){
  // districts
  const sd = el("selDistrict");
  sd.innerHTML = "";
  for(const d of GAME.districts){
    const opt = document.createElement("option");
    opt.value = d.name;
    opt.textContent = `${d.name} (${fmt(d.voters)} voters)`;
    sd.appendChild(opt);
  }
}

function renderDistrictPanel(){
  const d = GAME.districts.find(x=>x.name===el("selDistrict").value) || GAME.districts[0];
  el("districtTitle").textContent = d.name;

  const topIssue = issueByKey(d.topIssueKey)?.name ?? "—";
  const s = d.latent.support;

  const rows = [
    ["Voters", fmt(d.voters)],
    ["Skew", d.skew],
    ["Top local issue", topIssue],
    ["Turnout (true latent)", pct(d.latent.turnout)],
    ["Awareness (You)", pct(d.latent.awarenessYou)],
    ["Trust (You)", pct(d.latent.trustYou)],
    ["Support (You)", pct(s.you)],
    ["Support (Con)", pct(s.con)],
    ["Support (Lab)", pct(s.lab)],
    ["Support (Ind)", pct(s.ind)],
    ["Contacts (doors / leaflets / social / press / gotv)", `${fmt(d.contact.doors)} / ${fmt(d.contact.leaflets)} / ${fmt(d.contact.socialImpressions)} / ${fmt(d.contact.pressHits)} / ${fmt(d.contact.gotvTouches)}`],
  ];

  const tb = el("districtStats");
  tb.innerHTML = "";
  for(const [k,v] of rows){
    const tr = document.createElement("tr");
    tr.innerHTML = `<th>${k}</th><td class="right">${v}</td>`;
    tb.appendChild(tr);
  }

  const hist = el("districtHistory");
  if(d.history.length === 0){
    hist.textContent = "No activity yet.";
  } else {
    hist.textContent = d.history.slice(-10).map(h=>{
      const issue = issueByKey(h.issueKey)?.name ?? h.issueKey;
      const b = h.backlash ? " ⚠ backlash" : "";
      return `W${h.week}: ${h.action} • ${issue} • ${h.tone}/${h.frame} • int ${h.intensity} • shift ${(h.shift*100).toFixed(2)}pp • turnout +${(h.turnoutBoost*100).toFixed(2)}pp${b}`;
    }).join("\n");
  }
}

function renderAllDistricts(){
  const tb = el("allDistricts");
  tb.innerHTML = "";
  for(const d of GAME.districts){
    const s = d.latent.support;
    const top = issueByKey(d.topIssueKey)?.name ?? d.topIssueKey;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${d.name}</td>
      <td class="right">${fmt(d.voters)}</td>
      <td class="right">${(d.latent.turnout*100).toFixed(1)}%</td>
      <td class="right"><b>${(s.you*100).toFixed(1)}%</b></td>
      <td class="right">${(s.con*100).toFixed(1)}%</td>
      <td class="right">${(s.lab*100).toFixed(1)}%</td>
      <td class="right">${(s.ind*100).toFixed(1)}%</td>
      <td>${top}</td>
    `;
    tb.appendChild(tr);
  }
}

let LAST_POLL = null;
function renderPoll(){
  const tb = el("pollTable");
  tb.innerHTML = "";

  const truthLV = computeLikelyVoterTotals();
  const poll = LAST_POLL ?? noisyPollFromTruth(truthLV);

  const rows = [
    { name: GAME.candidate.name, pct: poll.support.you, note: "Your campaign" },
    { name: "Margaret Holloway (Con)", pct: poll.support.con, note: "Incumbent advantage possible" },
    { name: "Liam Carter (Lab)", pct: poll.support.lab, note: "Ground game pressure" },
    { name: "Nadia Rahman (Ind)", pct: poll.support.ind, note: "Local issue wildcard" },
  ].sort((a,b)=>b.pct-a.pct);

  for(const r of rows){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${r.name}</td><td class="right">${(r.pct*100).toFixed(1)}</td><td class="muted">${r.note}</td>`;
    tb.appendChild(tr);
  }
  el("pollMeta").textContent = `n=${poll.n} • MoE≈±${(poll.moE*100).toFixed(1)}pp • est turnout ${(poll.turnout*100).toFixed(1)}%`;
  el("pollCaveat").textContent = "Polling is noisy and lags reality. Your canvass returns can disagree with polls. That’s intended.";
}

function renderBudgets(){
  const late = GAME.week >= Math.floor(GAME.totalWeeks*0.75);
  const a = el("selAction").value;
  // show quick indicative costs
  const i = parseInt(el("rngIntensity").value,10);
  const costs = {
    canvass: { money: 20, vol: 18*i, energy: 6+i },
    leaflet: { money: 120*i, vol: 10*i, energy: 2+Math.floor(i/2) },
    social: { money: 90*i, vol: 2, energy: 2 },
    press: { money: 0, vol: 0, energy: 10+i },
    gotv: { money: 40, vol: 16*i, energy: 7+i },
  }[a];
  el("actionBudgetTag").textContent = `Cost: £${costs.money} • Vol ${costs.vol} • Energy ${costs.energy}${(a==="gotv" && !late) ? " • (locked)" : ""}`;
  el("weekNotes").textContent = a==="attack" ? "High risk" : "";
}

function appendEventLog(lines){
  const box = el("eventLog");
  const existing = box.textContent === "—" ? "" : box.textContent + "\n";
  box.textContent = (existing + lines.join("\n")).trim() || "—";
}

/* ---------- Turn Flow ---------- */
function executeActionClick(){
  const action = el("selAction").value;
  const districtName = el("selDistrict").value;
  const issueKey = el("selIssue").value;
  const frame = el("selFrame").value;
  const tone = el("selTone").value;
  const intensity = parseInt(el("rngIntensity").value,10);

  const res = applyAction({ action, districtName, issueKey, frame, tone, intensity });
  if(!res.ok){
    alert(res.msg);
    return;
  }

  // Log the action outcome
  const issue = issueByKey(issueKey).name;
  const b = res.backlash ? ` ⚠ Backlash (p≈${Math.round(res.backlashP*100)}%)` : "";
  const line = `W${GAME.week} ACTION: ${action} @ ${districtName} • ${issue} • ${tone}/${frame} int${intensity} ⇒ shift ${(res.shift*100).toFixed(2)}pp, turnout +${(res.turnoutBoost*100).toFixed(2)}pp${b}`;
  appendEventLog([line]);

  // Poll becomes stale until run again (unless you want automatic weekly polling)
  LAST_POLL = null;

  rerender();
}

function runInternalPoll(){
  const cost = 250;
  if(GAME.resources.money < cost){ alert("Not enough money for a poll."); return; }
  GAME.resources.money -= cost;

  const truthLV = computeLikelyVoterTotals();
  LAST_POLL = noisyPollFromTruth(truthLV);

  appendEventLog([`W${GAME.week} INTERNAL POLL: fielded (n=${LAST_POLL.n}) • MoE≈±${(LAST_POLL.moE*100).toFixed(1)}pp.`]);
  rerender();
}

function advanceWeek(){
  // 1) Opponents act
  opponentPhase();

  // 2) Events happen
  const ev = eventsPhase();
  if(ev.length) appendEventLog(ev);

  // 3) Saturation decays
  decaySaturation();

  // 4) Refresh resources (fundraising/recruitment)
  const inc = refreshWeeklyResources();
  appendEventLog([`W${GAME.week} WRAP: +£${fmt(inc.fund)} fundraising • +${fmt(inc.vols)} volunteer hours • +${fmt(inc.energyRegen)} energy.`]);

  // 5) Next week
  GAME.week += 1;
  if(GAME.week > GAME.totalWeeks){
    endElection();
    return;
  }

  // New snapshot for reset button
  snapshotWeek();

  // Poll becomes stale
  LAST_POLL = null;

  rerender();
}

function endElection(){
  // Simulate election outcome from latent support & turnout per district
  // Winner = highest vote share among those who turn out.
  const totals = { you:0, con:0, lab:0, ind:0 };
  let votesCast = 0;

  for(const d of GAME.districts){
    const cast = Math.round(d.voters * d.latent.turnout);
    votesCast += cast;
    totals.you += Math.round(cast * d.latent.support.you);
    totals.con += Math.round(cast * d.latent.support.con);
    totals.lab += Math.round(cast * d.latent.support.lab);
    totals.ind += Math.round(cast * d.latent.support.ind);
  }

  const arr = [
    ["You", totals.you],
    ["Con", totals.con],
    ["Lab", totals.lab],
    ["Ind", totals.ind]
  ].sort((a,b)=>b[1]-a[1]);

  const winner = arr[0][0];
  const margin = arr[0][1] - arr[1][1];

  const msg =
`ELECTION RESULT — ${GAME.ward.name}
Votes cast: ${fmt(votesCast)} (turnout ${(votesCast/GAME.ward.electorate*100).toFixed(1)}%)

You: ${fmt(totals.you)}
Con: ${fmt(totals.con)}
Lab: ${fmt(totals.lab)}
Ind: ${fmt(totals.ind)}

Winner: ${winner} by ${fmt(margin)} votes.`;

  appendEventLog(["—".repeat(30), msg, "Campaign complete. Refresh to play again (or extend the prototype)."]);
  el("btnNext").disabled = true;
  el("btnDoAction").disabled = true;
  el("btnPoll").disabled = true;
  alert(msg);
}

function rerender(){
  renderHeader();
  renderKPIs();
  renderIssues();
  renderCandidateStats();
  renderSelectors();
  renderDistrictPanel();
  renderAllDistricts();
  renderPoll();
  renderBudgets();
}

/* ---------- Init ---------- */
function init(){
  makeDistricts();
  snapshotWeek();

  // wire up
  el("selDistrict").addEventListener("change", renderDistrictPanel);
  el("selAction").addEventListener("change", () => { renderBudgets(); });
  el("selTone").addEventListener("change", renderBudgets);
  el("selIssue").addEventListener("change", renderBudgets);
  el("rngIntensity").addEventListener("input", renderBudgets);

  el("btnDoAction").addEventListener("click", executeActionClick);
  el("btnResetWeek").addEventListener("click", () => { restoreWeek(); rerender(); });
  el("btnNext").addEventListener("click", advanceWeek);
  el("btnPoll").addEventListener("click", runInternalPoll);

  // initial poll
  LAST_POLL = noisyPollFromTruth(computeLikelyVoterTotals());
  appendEventLog([`W1: Campaign begins in ${GAME.ward.name}. Initial internal poll available.`]);

  rerender();
}

init();
</script>
</body>
</html>
