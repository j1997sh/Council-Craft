<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ward Manager (UK)</title>
<style>
:root{
  color-scheme: light dark;
  --bg: Canvas;
  --fg: CanvasText;
  --muted: color-mix(in oklab, var(--fg) 60%, transparent);
  --line: color-mix(in oklab, var(--fg) 20%, transparent);
  --card: color-mix(in oklab, var(--bg) 92%, var(--fg) 8%);
  --good:#0a7;
  --bad:#b00020;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:var(--bg);color:var(--fg)}
header{
  display:flex;gap:12px;align-items:center;
  padding:12px 16px;border-bottom:1px solid var(--line)
}
nav button{
  border:1px solid var(--line);
  background:transparent;border-radius:999px;
  padding:6px 12px;font-weight:700;cursor:pointer;
  color:var(--muted)
}
nav button.active{background:var(--card);color:var(--fg)}
main{max-width:1200px;margin:0 auto;padding:16px}
.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:12px;
  padding:14px;margin-bottom:14px
}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.spacer{flex:1}
h2{margin:0 0 8px 0}
.small{font-size:12px;color:var(--muted)}
button.action{
  border:1px solid var(--line);
  background:transparent;border-radius:10px;
  padding:10px 12px;font-weight:700;cursor:pointer
}
table{width:100%;border-collapse:collapse}
th,td{padding:8px 6px;border-bottom:1px solid var(--line);font-size:13px;text-align:left}
th{color:var(--muted)}
.log{font-family:ui-monospace,monospace;font-size:12px;white-space:pre-wrap}
.hidden{display:none}
.good{color:var(--good)}
.bad{color:var(--bad)}
canvas{width:100%;height:120px}
</style>
</head>

<body>
<header>
  <h1>Ward Manager (UK)</h1>
  <nav>
    <button data-screen="hq" class="active">Campaign HQ</button>
    <button data-screen="field">Field</button>
    <button data-screen="intel">Intel</button>
  </nav>
  <div class="spacer"></div>
  <b id="weekLabel"></b>
</header>

<main>

<!-- HQ -->
<section id="screen-hq">
  <div class="card">
    <h2>Resources</h2>
    <div class="row">
      <span>Money £<b id="money"></b></span>
      <span>Energy <b id="energy"></b></span>
      <span>Volunteers <b id="volCount"></b></span>
    </div>
  </div>

  <div class="card">
    <h2>Fundraising</h2>
    <div class="row">
      <button class="action" onclick="fundraise('small')">Email small donors</button>
      <button class="action" onclick="fundraise('local')">Call local donors</button>
      <button class="action" onclick="fundraise('event')">Fundraising event</button>
    </div>
    <div class="small">
      Donor fatigue applies. Reputational risk on high-value donors.
    </div>
  </div>

  <div class="card">
    <h2>Campaign Actions</h2>
    <div class="row">
      <button class="action" onclick="canvass()">Door knock</button>
      <button class="action" onclick="leaflet()">Leaflet drop</button>
      <button class="action" onclick="rest()">Rest candidate</button>
    </div>
  </div>
</section>

<!-- FIELD -->
<section id="screen-field" class="hidden">
  <div class="card">
    <h2>Districts (latent)</h2>
    <table>
      <thead>
        <tr><th>District</th><th>You</th><th>Con</th><th>Lab</th><th>Ind</th></tr>
      </thead>
      <tbody id="districtTable"></tbody>
    </table>
  </div>
</section>

<!-- INTEL -->
<section id="screen-intel" class="hidden">
  <div class="card">
    <h2>Polling trend</h2>
    <canvas id="trend"></canvas>
    <div class="small">Internal polling (noisy)</div>
  </div>

  <div class="card">
    <h2>Campaign log</h2>
    <div class="log" id="log"></div>
  </div>

  <div class="card" id="postElection" class="hidden">
    <h2>Post-Election Analysis</h2>
    <div class="log" id="analysis"></div>
  </div>
</section>

</main>

<script>
/* ---------- STATE ---------- */
const GAME={
  week:1,totalWeeks:20,
  money:5000,energy:80,
  donors:{
    small:{fatigue:0.1},
    local:{fatigue:0.1},
    event:{fatigue:0}
  },
  districts:[
    {n:"Riverside",s:{you:.24,con:.28,lab:.36,ind:.12}},
    {n:"Old Greybridge",s:{you:.26,con:.42,lab:.22,ind:.10}},
    {n:"Kingsway",s:{you:.32,con:.30,lab:.26,ind:.12}},
    {n:"St Mark’s",s:{you:.18,con:.52,lab:.20,ind:.10}},
    {n:"Industrial",s:{you:.29,con:.26,lab:.33,ind:.12}},
  ],
  opponents:{
    con:{budget:6000,style:"defensive"},
    lab:{budget:4500,style:"ground"}
  },
  trend:[],
  log:[]
};

/* ---------- NAV ---------- */
document.querySelectorAll("nav button").forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll("nav button").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    document.querySelectorAll("main section").forEach(s=>s.classList.add("hidden"));
    document.getElementById("screen-"+b.dataset.screen).classList.remove("hidden");
  };
});

/* ---------- FUNDRAISING ---------- */
function fundraise(type){
  let base={small:300,local:700,event:1400}[type];
  let fatigue=GAME.donors[type].fatigue;
  let gain=Math.max(0,Math.floor(base*(1-fatigue)));
  GAME.money+=gain;
  GAME.energy-=5;
  GAME.donors[type].fatigue=Math.min(0.9,fatigue+0.15);
  GAME.log.push(`Fundraising (${type}) raised £${gain}.`);
  if(type==="local"&&Math.random()<0.3)
    GAME.log.push("Whispers about donor influence.");
  endWeek();
}

/* ---------- ACTIONS ---------- */
function canvass(){
  if(GAME.energy<10)return;
  GAME.energy-=10;
  let d=pick(GAME.districts);
  d.s.you+=0.015;
  GAME.log.push(`Canvassing improved support in ${d.n}.`);
  endWeek();
}
function leaflet(){
  if(GAME.money<300)return;
  GAME.money-=300;
  let d=pick(GAME.districts);
  d.s.you+=0.01;
  GAME.log.push(`Leaflets helped in ${d.n}.`);
  endWeek();
}
function rest(){
  GAME.energy=Math.min(100,GAME.energy+25);
  GAME.log.push("Candidate rested.");
  endWeek();
}

/* ---------- OPPONENT AI ---------- */
function opponentTurn(){
  // Conservative: protect strongholds late
  if(GAME.opponents.con.budget>500){
    let d=GAME.districts.find(x=>x.s.con>0.4);
    if(d){d.s.con+=0.01;GAME.opponents.con.budget-=400;}
  }
  // Labour: ground game in marginal
  if(GAME.opponents.lab.budget>400){
    let d=GAME.districts.find(x=>Math.abs(x.s.lab-x.s.you)<0.06);
    if(d){d.s.lab+=0.012;GAME.opponents.lab.budget-=300;}
  }
}

/* ---------- TURN ---------- */
function endWeek(){
  opponentTurn();
  GAME.trend.push(pollEstimate());
  GAME.week++;
  if(GAME.week>GAME.totalWeeks) return endElection();
  render();
}

/* ---------- POLLING ---------- */
function pollEstimate(){
  let avg=GAME.districts.reduce((a,d)=>a+d.s.you,0)/GAME.districts.length;
  return avg+(Math.random()-.5)*0.03;
}

/* ---------- ELECTION ---------- */
function endElection(){
  let totals={you:0,con:0,lab:0,ind:0};
  GAME.districts.forEach(d=>{
    for(let k in d.s) totals[k]+=d.s[k];
  });
  let winner=Object.entries(totals).sort((a,b)=>b[1]-a[1])[0][0];
  let a=`RESULT\nWinner: ${winner.toUpperCase()}\n\n`;
  for(let k in totals) a+=`${k}: ${(totals[k]*100).toFixed(1)}%\n`;
  document.getElementById("analysis").textContent=a;
  document.getElementById("postElection").classList.remove("hidden");
  render();
}

/* ---------- RENDER ---------- */
function render(){
  weekLabel.textContent=`Week ${GAME.week}/${GAME.totalWeeks}`;
  money.textContent=GAME.money;
  energy.textContent=GAME.energy;
  volCount.textContent=3;

  districtTable.innerHTML="";
  GAME.districts.forEach(d=>{
    let r=document.createElement("tr");
    r.innerHTML=`<td>${d.n}</td>
      <td>${(d.s.you*100).toFixed(1)}</td>
      <td>${(d.s.con*100).toFixed(1)}</td>
      <td>${(d.s.lab*100).toFixed(1)}</td>
      <td>${(d.s.ind*100).toFixed(1)}</td>`;
    districtTable.appendChild(r);
  });

  drawTrend();
  log.textContent=GAME.log.slice(-10).join("\n");
}

/* ---------- TREND GRAPH ---------- */
function drawTrend(){
  const c=document.getElementById("trend");
  const ctx=c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);
  ctx.beginPath();
  GAME.trend.forEach((v,i)=>{
    let x=i*(c.width/(GAME.trend.length-1||1));
    let y=c.height*(1-v);
    i?ctx.lineTo(x,y):ctx.moveTo(x,y);
  });
  ctx.strokeStyle="currentColor";
  ctx.stroke();
}

/* ---------- UTILS ---------- */
function pick(a){return a[Math.floor(Math.random()*a.length)]}

/* INIT */
render();
</script>
</body>
</html>
